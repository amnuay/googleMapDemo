<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta charset="utf-8">
    <style type="text/css">
        html, body{
            height: 100%;
            margin: 0px;
            padding: 0px
        }

        #map_canvas{
            width:100%;
            height:100%
        }
    </style>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">

    var gmapdrive = {
        start: '华中科技大学',
        end: '光谷软件园',
        timeInterval: 100,
        speed: 100,
        granularity: 5,
        map: null,
        directionsDisplay: null,
        directionsService: null,
        directionsResult: null,
        currentDirections: null,
        pathArray: [],
        newPathArray: [],
        latlngArray: [],
        index: 0,
        dis: 0,
        stop: false,      

        init: function (){
            this.mapOption = {
                zoom: 20,
                center: new google.maps.LatLng(30.507510000000003, 114.41362000000001),
                scaleControl: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            this.marker = new google.maps.Marker({
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    fillColor: "yellow",
                    fillOpacity: 0.8,
                    rotation: 40,
                    scale: 4,
                    strokeColor: "green"
                },
            });

            this.map = new google.maps.Map(document.getElementById("map_canvas"), this.mapOption);

            this.directionsService = new google.maps.DirectionsService();
            this.directionsDisplay = new google.maps.DirectionsRenderer({
                'map': this.map,
                'preserveViewport': true,
                'draggable': true
            });
            this.getRoutes();
        },

        getRoutes: function getRoutes() {
            this.index = 0;
            this.newPathArray = [];
            this.stop = false;
            var request = {
                origin:this.start,
                destination:this.end,
                travelMode: google.maps.TravelMode.DRIVING,
                provideRouteAlternatives: true
            };
            gmapdrive.directionsService.route(request, function(response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    gmapdrive.directionsDisplay.setDirections(response);
                    gmapdrive.directionsResult = response;
                    // updateRoutes(response);
                    gmapdrive.map.setZoom(19);
                    gmapdrive.pathArray = gmapdrive.getAllLatlngs(response, 0);
                    gmapdrive.routeLength = gmapdrive.pathArray.length - 1
                    //gmapdrive.latlngArray = gmapdrive.calclatLngs(gmapdrive.pathArray, gmapdrive.granularity)
                    gmapdrive.currentlatlng = gmapdrive.pathArray[0];
                    gmapdrive.newPathArray.push(gmapdrive.currentlatlng);
                    gmapdrive.changeStartEndPoint();
                    gmapdrive.jl = gmapdrive.speed / gmapdrive.granularity; // jack jl
                    timerStart();
                }
            });
        },

        clearMarker: function clearMarker(){
            for (i = 0; i < this.markerArray.length; i++) {
                this.markerArray[i].setMap(null);
            }
            this.markerArray = [];
        },

        getAllLatlngs: function getAllLatlngs(directionsResult, routeIndex){
            var latLngs = [];
            var steps = directionsResult.routes[routeIndex].legs[0].steps;
            var lengthsteps = steps.length
            var path, lengthpath, lengthsteps;
            for (var i = 0; i < lengthsteps; i++) {
                path = steps[i].path;
                lengthpath = path.length;
                if(i < lengthpath - 1){
                    for (var j = 0; j < lengthpath - 1; j++) {
                        latLngs.push(path[j]);
                    };
                }
                else if (i == lengthsteps - 1){
                    for (var j = 0; j < lengthpath; j++) {
                        latLngs.push(path[j]);
                    };
                }   
            };
            return latLngs;
        },

        changeStartEndPoint: function(){
            var computeDistanceBetween = google.maps.geometry.spherical.computeDistanceBetween;
            var computeHeading = google.maps.geometry.spherical.computeHeading;
            var computeOffset = google.maps.geometry.spherical.computeOffset;
            this.startlatlng = this.pathArray[this.index];
            this.endlatlng = this.pathArray[this.index + 1];
            this.distance = computeDistanceBetween(this.startlatlng, this.endlatlng);
            this.rotation = computeHeading(this.startlatlng, this.endlatlng);
        },
        moveMarker: function(){
            var computeDistanceBetween = google.maps.geometry.spherical.computeDistanceBetween;
            var computeHeading = google.maps.geometry.spherical.computeHeading;
            var computeOffset = google.maps.geometry.spherical.computeOffset;
            this.dis += this.jl;
            if (this.dis < this.distance){
                this.currentlatlng = computeOffset(this.currentlatlng, this.jl, this.rotation);
                this.jl = this.speed / this.granularity;
                this.changeMarkerPostion();
                this.newPathArray.push(this.currentlatlng);
            }else{
                var halfdistance = 0;
                halfdistance = computeDistanceBetween(this.currentlatlng, this.endlatlng);
                this.jl = this.jl - halfdistance;
                this.index += 1;
                if (this.index == this.routeLength){
                    this.currentlatlng = this.endlatlng;
                    this.changeMarkerPostion();
                    this.newPathArray.push(this.currentlatlng);
                    this.stop = true;
                    return ;
                }
                this.changeStartEndPoint();
                this.currentlatlng = this.startlatlng;
                this.dis = 0;
                this.moveMarker();
            }
        },

        showMarker: function(latlng){
            this.marker.setMap(this.map);
        },

        changeMarkerPostion: function(){
            this.marker.setOptions({
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    fillColor: "yellow",
                    fillOpacity: 0.8,
                    rotation: this.rotation,
                    scale: 4,
                    strokeColor: "green"
                },
            });
            this.marker.setPosition(this.currentlatlng);
            this.marker.setMap(this.map);
            this.map.panTo(this.currentlatlng);
            // this.map.setZoom(20);
        },

        hideMarker: function(){
            this.marker.setMap(null);
        },

        changeSpeed: function(sp){
            this.speed += sp;
        }
    }

    function timerStart(){
        gmapdrive.moveMarker();
        if (!gmapdrive.stop){
            window.setTimeout("timerStart()", 1000 /gmapdrive.granularity);
        }
    }
    
    function initialize(){
        gmapdrive.init();
        gmapdrive.contextMenu = google.maps.event.addListener(gmapdrive.map, "rightclick", createMenu);
        function createMenu(event) {
            console.log(event);
        }
    }

    $(document).ready(function() {
        google.maps.event.addDomListener(window, 'load', initialize);
    });
    </script>
</head>
<body>
    <div id="map_canvas"></div>
</body>
</html>
